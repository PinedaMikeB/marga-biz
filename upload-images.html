<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marga Image Uploader - Browser Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .content {
            padding: 40px;
        }
        
        .step {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            margin: 10px 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            display: none;
        }
        
        .log-entry {
            margin: 5px 0;
        }
        
        .success { color: #00ff00; }
        .error { color: #ff4444; }
        .info { color: #44aaff; }
        .warning { color: #ffaa00; }
        
        .progress {
            background: #e0e0e0;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        
        .progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
            display: none;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            text-align: center;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî• Marga Image Uploader</h1>
            <p>Browser-Based - No Terminal Needed!</p>
        </div>
        
        <div class="content">
            <!-- Instructions -->
            <div class="step">
                <h2>üìã How This Works</h2>
                <ol style="margin: 15px 0; padding-left: 25px; line-height: 1.8;">
                    <li>This tool reads your WordPress data</li>
                    <li>Extracts all image URLs</li>
                    <li>Downloads images in your browser</li>
                    <li>Uploads to Firebase Storage</li>
                    <li>Updates your HTML with Firebase URLs</li>
                </ol>
                <p style="margin-top: 15px; color: #666;">
                    <strong>Note:</strong> All processing happens in your browser. No server needed!
                </p>
            </div>
            
            <!-- Status -->
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="stat-number" id="foundCount">0</div>
                    <div>Images Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number success" id="uploadedCount">0</div>
                    <div>Uploaded</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number error" id="failedCount">0</div>
                    <div>Failed</div>
                </div>
            </div>
            
            <!-- Progress -->
            <div class="progress" id="progress">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            
            <!-- Start Button -->
            <div style="text-align: center; margin: 30px 0;">
                <button class="btn" id="startBtn" onclick="startUpload()">
                    üöÄ Start Upload
                </button>
                <button class="btn" id="downloadBtn" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); display: none;" onclick="downloadHTML()">
                    üì• Download Updated HTML
                </button>
            </div>
            
            <!-- Log -->
            <div class="log" id="log"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCgPJs1Neq2bRMAOvREBeV-f2i_3h1Qx3M",
            authDomain: "sah-spiritual-journal.firebaseapp.com",
            projectId: "sah-spiritual-journal",
            storageBucket: "sah-spiritual-journal.firebasestorage.app",
            messagingSenderId: "450636566224",
            appId: "1:450636566224:web:5c46eb4b827e6fd3ad58d5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        
        log('‚úÖ Firebase initialized', 'success');
        log('üìä Storage bucket: ' + firebaseConfig.storageBucket, 'info');

        let wpData = null;
        let imageUrls = [];
        let urlMapping = {};
        let uploadedCount = 0;
        let failedCount = 0;
        let updatedHTML = '';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            logDiv.style.display = 'block';
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function startUpload() {
            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            btn.textContent = 'Loading...';
            
            document.getElementById('stats').style.display = 'grid';
            document.getElementById('progress').style.display = 'block';
            
            log('üöÄ Starting image upload process...', 'info');
            
            try {
                // Load WordPress data
                log('üìÅ Loading WordPress data...', 'info');
                
                // Try to load from data folder
                let response;
                try {
                    response = await fetch('data/wordpress-data.json');
                    if (!response.ok) throw new Error('File not found');
                } catch (e) {
                    // Try alternate path
                    response = await fetch('../data/wordpress-data.json');
                    if (!response.ok) {
                        throw new Error('Cannot find wordpress-data.json. Please make sure the file exists in the data/ folder.');
                    }
                }
                
                wpData = await response.json();
                log(`‚úÖ Loaded data for ${wpData.pages.length} pages`, 'success');
                
                // Extract image URLs
                log('üîç Extracting image URLs...', 'info');
                extractImageUrls();
                
                document.getElementById('foundCount').textContent = imageUrls.length;
                log(`‚úÖ Found ${imageUrls.length} unique images`, 'success');
                
                // Upload images
                log('üì§ Starting uploads...', 'info');
                await uploadAllImages();
                
                // Update HTML
                log('üîÑ Updating HTML...', 'info');
                await updateHTML();
                
                log('üéâ All done! Click "Download Updated HTML" below', 'success');
                document.getElementById('downloadBtn').style.display = 'inline-block';
                
            } catch (error) {
                log('‚ùå Error: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Retry Upload';
            }
        }

        function extractImageUrls() {
            const urls = new Set();
            
            // Helper function
            function extractFromContent(content) {
                if (!content) return;
                
                // Match WordPress upload URLs
                const patterns = [
                    /https?:\/\/marga\.biz\/wp-content\/uploads\/[^\s"'<>]+\.(jpg|jpeg|png|gif|webp|svg)/gi,
                    /http:\/\/marga\.biz\/wp-content\/uploads\/[^\s"'<>]+\.(jpg|jpeg|png|gif|webp|svg)/gi
                ];
                
                patterns.forEach(pattern => {
                    const matches = [...content.matchAll(pattern)];
                    matches.forEach(match => urls.add(match[0]));
                });
            }
            
            // Find homepage
            const homepage = wpData.pages.find(p => 
                p.slug === 'copier-rental' || 
                p.slug === '' || 
                p.link.endsWith('.biz/')
            );
            
            if (homepage) {
                extractFromContent(homepage.content);
                log('‚úÖ Extracted images from homepage', 'info');
            }
            
            // Extract from top pages
            wpData.pages.slice(0, 50).forEach(page => {
                extractFromContent(page.content);
            });
            
            imageUrls = Array.from(urls);
        }

        async function uploadAllImages() {
            const total = imageUrls.length;
            
            for (let i = 0; i < imageUrls.length; i++) {
                const url = imageUrls[i];
                const percent = Math.round(((i + 1) / total) * 100);
                
                updateProgress(i + 1, total, percent);
                
                try {
                    await uploadImage(url);
                } catch (error) {
                    log(`‚ö†Ô∏è  Skipped: ${url} (${error.message})`, 'warning');
                }
                
                // Small delay to avoid overwhelming the browser
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        async function uploadImage(url) {
            try {
                // Get filename
                const filename = url.split('/').pop().split('?')[0];
                const firebasePath = `public/website/${filename}`;
                
                log(`üì• Uploading: ${filename}`, 'info');
                
                // Download image as blob
                const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                if (!response.ok) throw new Error('Download failed');
                
                const blob = await response.blob();
                
                // Upload to Firebase
                const storageRef = storage.ref(firebasePath);
                await storageRef.put(blob, {
                    cacheControl: 'public, max-age=31536000'
                });
                
                // Get public URL
                const downloadURL = await storageRef.getDownloadURL();
                urlMapping[url] = downloadURL;
                
                uploadedCount++;
                document.getElementById('uploadedCount').textContent = uploadedCount;
                log(`‚úÖ Uploaded: ${filename}`, 'success');
                
            } catch (error) {
                failedCount++;
                document.getElementById('failedCount').textContent = failedCount;
                throw error;
            }
        }

        function updateProgress(current, total, percent) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = `${current} / ${total} (${percent}%)`;
        }

        async function updateHTML() {
            // Load current index.html
            const response = await fetch('index.html');
            let html = await response.text();
            
            // Replace URLs
            let replacements = 0;
            Object.entries(urlMapping).forEach(([oldUrl, newUrl]) => {
                if (html.includes(oldUrl)) {
                    html = html.replace(new RegExp(oldUrl.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), newUrl);
                    replacements++;
                }
            });
            
            updatedHTML = html;
            log(`‚úÖ Updated ${replacements} image URLs`, 'success');
        }

        function downloadHTML() {
            const blob = new Blob([updatedHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'index-updated.html';
            a.click();
            URL.revokeObjectURL(url);
            
            log('‚úÖ Downloaded! Replace your index.html with index-updated.html', 'success');
        }
    </script>
</body>
</html>
